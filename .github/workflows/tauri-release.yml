name: Tauri Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: Release tag to publish assets to (for example v0.1.0)
        required: true
        type: string
      release_name:
        description: Release name (optional)
        required: false
        type: string
      release_body:
        description: Release body (optional)
        required: false
        type: string
      prerelease:
        description: Mark release as prerelease
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
          - platform: windows-latest
          - platform: macos-latest

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux build dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            editor/src-tauri -> target

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install frontend dependencies
        working-directory: editor
        run: bun install --frozen-lockfile

      - name: Build and publish Tauri bundles
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: editor
          tauriScript: bunx tauri
          tagName: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.event.release.tag_name }}
          releaseName: ${{ github.event_name == 'workflow_dispatch' && (inputs.release_name != '' && inputs.release_name || inputs.tag_name) || github.event.release.name }}
          releaseBody: ${{ github.event_name == 'workflow_dispatch' && (inputs.release_body != '' && inputs.release_body || 'Automated build via workflow_dispatch') || github.event.release.body }}
          releaseDraft: false
          prerelease: ${{ github.event_name == 'workflow_dispatch' && inputs.prerelease || github.event.release.prerelease }}

      - name: Prepare portable exe
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $tag = "${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.event.release.tag_name }}"
          $source = "editor/src-tauri/target/release/app.exe"
          if (-not (Test-Path $source)) {
            throw "Portable exe not found at $source"
          }
          $portableName = "Symi-Editor-$tag-windows-portable.exe"
          Copy-Item $source $portableName -Force

      - name: Upload portable exe to release
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.event.release.tag_name }}
          files: Symi-Editor-*-windows-portable.exe
