---
title: 宏
description: 宏定义和调用
navigation:
---

宏是Symi中一种强大的抽象机制，允许你定义可重用的代码块，并在需要的地方调用它们，这在音乐的重复结构中尤其有用。

## 定义宏

宏定义的基本形式都是：

```
宏名 = ...
```

其中宏名使用标识符（字母、数字、下划线组合，且不能以数字开头）。

### 简单宏

简单宏用于定义一组**音高表达式**，适合重复的音型片段，也可以看作给音高取别名。简单宏的内容是用`:`分隔的音高，例如：

```
arp = 1/1:3/2:2/1
```

上例定义了一个名为 `arp` 的简单宏，内部是一个三音组。

简单宏只负责“音高内容”的复用，不在定义处固定时间戳推进；实际时值与节奏由调用位置决定。

### 复杂宏

复杂宏用于定义完整的**行级片段**（可包含时间控制、和弦、分号细分、控制信息等）。

写法是将 `=` 后换行，然后在下一行（或多行）书写宏体，**最后用一个额外的空白行结束**：

```
riff =
{4}C,E,G,E,
D,F,A,F,

```

如果宏体只有一行，也可以直接写在 `=` 后，但是宏体必须以非音高标记开头：

```
riff = {4}C,E,G,E,   // 这是合法的单行复杂宏定义
riff = C,E,G,E,     // 这样写是不合法的，因为宏体以音高标记开头，编译器无法区分这是一个简单宏还是复杂宏
```

复杂宏的宏体在逻辑上是一段独立片段：
- 宏体内部按自身内容推进时间；
- 调用时会将宏体事件整体平移到调用位置；
- 宏体可以包含多个小节（多行）。

::tip
[小节分隔记号](./time#小节分隔记号)看起来就像是没有名字的单行复杂宏，其实它就是对复杂宏的一种特殊语法糖。
::

## 调用宏

宏调用的基础形式是直接写宏名：

```
arp,
riff,
```

### 调用时指定临时主音

调用宏时可以在宏名后使用 `@` 接音高（或音高链），临时改变该次展开时的主音参考：

```
arp@D4,
arp@C4@3/2,
riff@A3,
```

其语义与[音高链](./pitch#音高链)一致：`@` 从右向左计算。计算结果会被用作该次宏调用的临时基准音（仅对本次调用生效）。

这对简单宏和复杂宏都生效。

### 示例

```
<C4=261.63>

arp = 1/1:3/2:2/1
riff =
{4}C,E,G,E,
D,F,A,F,

{1}arp,
arp@D4,
riff,
,
riff@A3,
```

上例中：
- `arp` 与 `riff` 按当前基准音展开；
- `arp@D4` 与 `riff@A3` 会先临时切换基准音，再展开宏内容；
- 展开结束后，外层基准音恢复，不影响后续其他内容。
